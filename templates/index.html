{% extends 'query.html' %}
{% load static %}
{% block status %}{% endblock %}
{% block index %}mm-active{% endblock %}
{% block query %}{% endblock %}
{% block examination %}{% endblock %}
{% block dashboard_bar %}知识图谱3D可视化{% endblock %}

{% block body %}
    {% block popup %}
        <link rel="stylesheet" type="text/css" href="{% static 'css/dialog-donna.css' %}">
    {% endblock %}
    <script src="{% static 'js/jquery.min.js' %}"></script>
    <script src="https://unpkg.com/d3-dsv"></script>
    <script src="https://unpkg.com/dat.gui"></script>
    <script src="https://unpkg.com/d3-octree"></script>
    <script src="https://unpkg.com/d3-force-3d"></script>

    <script src="https://unpkg.com/3d-force-graph"></script>
    <script src="https://unpkg.com/three"></script>
    <script src="//unpkg.com/vue/dist/vue.js"></script>
    <script src="//unpkg.com/element-ui@2.15.3/lib/index.js"></script>
    <script src="https://unpkg.com/neo4j-driver"></script>
    <style>
        .dg.main.a {
            width: 245px;
            position: relative;
            top: 80px;
        }
    </style>
    <div class="content-body">
        <div class="container-fluid">
            <div id="3d-graph"></div>
            <div id="Popup" class="dialog" style="z-index: 100">
                <div class="dialog__overlay"></div>
                <div class="dialog__content">
                    <p id="title"></p>
                    <p id="introduction" style="height:200px;width:400px;overflow:auto;">
                    </p>
                    <div style="text-align: left">
                        <i>
                            <svg t="1625296502770" class="icon" viewBox="0 0 1024 1024" version="1.1"
                                 xmlns="http://www.w3.org/2000/svg" p-id="4140" width="20" height="20">
                                <path d="M722.8 459l-18.9 18.9-2.7 2.7-4.7 4.8-52.7 52.7 26.3 26.3 52.7-52.7 184.4 184.4-210.7 210.8-184.4-184.4 52.6-52.7-26.3-26.4-52.7 52.7-26.3 26.4 237.1 237.1 263.4-263.5z"
                                      fill="#060001" p-id="4141"></path>
                                <path d="M327.7 353.6l342.5 342.5 26.3-26.3L354 327.3z" fill="#060001"
                                      p-id="4142"></path>
                                <path d="M301.3 511.7L116.9 327.3l210.8-210.7L512.1 301l-52.7 52.6 26.3 26.4 52.7-52.7 26.3-26.4-237-237L64.2 327.3l237.1 237.1 26.3-26.3 52.8-52.7L354 459z"
                                      fill="#060001" p-id="4143"></path>
                            </svg>
                        </i>
                        来源：<a id="origin" style="border-bottom:1px dashed #db0707;" href="#" target="_blank">查看详情</a>
                    </div>
                    <div style="text-align: right">
                        <button class="action" data-dialog-close="">关闭</button>
                    </div>
                </div>
            </div>
            <script>
                const elem = document.getElementById('3d-graph');
                const driver = neo4j.driver('bolt://localhost', neo4j.auth.basic('neo4j', 'ztj19991124'))  //连接neo4j数据库
                const session = driver.session();  //创建会话进行数据库操作
                const start = new Date()
                session
                    //采用社区发现算法louvain进行图结构的构造
                    .run('MATCH (n)-[r]->(m) RETURN { id: id(n), label:head(labels(n)), name:n.name, size:toInteger(n.size)*2 } as source, { id: id(m), label:head(labels(m)), name:m.name, size:toInteger(n.size)*0.5 } as target, {weight:5, type:type(r)} as rel LIMIT $limit', {limit: 5000})
                    .then(function (result) {
                        const nodes = {}
                        const links = result.records.map(r => {
                            var source = r.get('source');  //源节点
                            source.id = source.id.toNumber();
                            nodes[source.id] = source;
                            var target = r.get('target');  //目的节点
                            target.id = target.id.toNumber();
                            nodes[target.id] = target;
                            var rel = r.get('rel');  //关系
                            if (rel.weight) {
                                rel.weight = rel.weight.toNumber();
                            }
                            return Object.assign({source: source.id, target: target.id}, rel);
                        });
                        session.close();
                        console.log((new Date() - start) + "毫秒内加载了" + links.length + "个链接")  //统计花费的时间
                        const gData = {nodes: Object.values(nodes), links: links}
                        {#console.log(nodes)#}
                        var Popup = document.getElementById('Popup'),
                            dlg = new DialogFx(Popup);

                        const elem = document.getElementById('3d-graph');
                        const Graph = ForceGraph3D()(elem)
                            .dagMode('td')
                            .dagLevelDistance(200)
                            .graphData(gData)
                            .nodeAutoColorBy('label')
                            .nodeOpacity(0.98)                            //节点透明度
                            .backgroundColor('rgba(0,0,0,0)')             //背景色
                            .linkOpacity(0.4)                            //连线透明度
                            .linkAutoColorBy(link => link.color)          //连线颜色
                            {#.linkColor(() => 'rgb(158,158,139)')#}
                            .linkResolution(8)                            //连线分辨率
                            .nodeResolution(30)                           //节点分辨率
                            .linkDirectionalParticles(2)                  //粒子数量
                            .linkDirectionalParticleWidth(1.75)              //粒子宽度
                            .linkDirectionalParticleSpeed(0.0075)         //粒子速度
                            .nodeVal('size')
                            {#.nodeRelSize(6)#}
                            .onNodeDragEnd(node => {  //拖拽节点固定
                                node.fx = node.x;
                                node.fy = node.y;
                                node.fz = node.z;
                            })
                            .d3VelocityDecay(0.5)
                            .nodeLabel(node => `<p style="font-size: 20px;user-select:none;color: #0D0A0A">${node.label}: ${node.name}<p>`)
                            .onNodeClick(node => {
                                (function () {
                                    $.ajax({
                                        url: '/index/',
                                        type: 'POST',
                                        dataType: 'json',
                                        data: {
                                            'nodeName': `${node.name}`,
                                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                                        },
                                        success: function (data) {
                                            $("#title").html('<strong>' + `${node.name}` + '</strong>');
                                            $("#introduction").html(data.introduction);
                                            $('#origin').attr('href', data.link);
                                            dlg.toggle.bind(dlg)()
                                        }
                                    })
                                }())
                                {#dlg.toggle.bind(dlg)()#}
                            });
                        // controls
                        const controls = {'DAG Orientation': 'td'};
                        const gui = new dat.GUI();
                        gui.add(controls, 'DAG Orientation', ['td', 'radialout', 'radialin', null])
                            .onChange(orientation => Graph && Graph.dagMode(orientation));

                    });
            </script>
        </div>
    </div>
{% endblock %}